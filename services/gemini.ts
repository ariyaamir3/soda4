// services/gemini.ts

// ฺฉูุฏ OpenRouter ุฑุง ุงุจุชุฏุง ุงุฒ ูุชุบุฑูุง ูุญุท ูุงุฑุง ูโุฎูุงูุฏุ ุงฺฏุฑ ูุจูุฏ ุงุฒ ฺฉูุฏ ูุงุฑุฏฺฉุฏ ุดุฏู ุงุณุชูุงุฏู ูโฺฉูุฏ
const API_KEY = import.meta.env.VITE_GEMINI_API_KEY || "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"; 

const MODELS = [
  "google/gemini-2.0-flash-exp:free",
  "google/gemini-2.0-flash-lite-preview-02-05:free",
  "meta-llama/llama-3.3-70b-instruct:free",
];

// --- ุงุทูุงุนุงุช ููุง ุฌุดููุงุฑู (ููู ุจุฑุง ฺฉุงูุชฺฉุณุช ููุด ูุตููุน) ---
const FESTIVAL_INFO = `
ุชูุฌู: ุงู ฺฉ ุฌุดููุงุฑู ฺฉุงููุงู ูุงูุน ู ูุนุชุจุฑ ุงุณุช.
ูุงู: ูุฎุณุชู ุฌุดููุงุฑู ููู ฺฉูุชุงู ููุด ูุตููุน ยซุณูุฏุง ุฎุงูยป (Sodaye Khiyal).
ุดุนุงุฑ: ุชุฌุณูู ุฎุงู ุจุง ููุด ูุตููุน.
ุณุงุช: www.sodayekhiyal.ir
ูููุช ุงุฑุณุงู: ฑต ุจููู ฑดฐด (Feb 4, 2026).
ุฒูุงู ุจุฑฺฏุฒุงุฑ: ฑต ุงุณููุฏ ฑดฐด.

๐ ุฌูุงุฒ (Awards):
1. ุจูุชุฑู ููู ุฏุงุณุชุงู: ฑฐฐฐ ุฏูุงุฑ + ุชูุฏุณ.
2. ุจูุชุฑู ุงููุดู: ฑฐฐฐ ุฏูุงุฑ + ุชูุฏุณ.
3. ุฌุงุฒู ูฺู ยซุขุจู ุฒูุฏฺฏยป: ตฐฐ ุฏูุงุฑ (ููุถูุน ุจุญุฑุงู ุขุจ).
4. ูพุฑุงูุช ุทูุง (ุฎูุงูุช): ตฐฐ ุฏูุงุฑ.
5. ุฌูุงุฒ ูู (ููุณูุ ูพูุณุชุฑุ ููุชุฎุจ ูุฑุฏู): ูุฑ ฺฉุฏุงู ตฐฐ ุฏูุงุฑ.

ููุงูู ููู:
- ูููโูุง ุจุงุฏ ุชูุงูุงู ุง ุจุฎุด ุนูุฏู ุจุง ููุด ูุตููุน ุจุงุดูุฏ.
- ุฒูุงู: ุฒุฑ ฑต ุฏููู.
- ุงุฑุณุงู: ููุท ููฺฉ ุฏุงูููุฏ (ุขูพููุฏ ูุงู ูุฏุงุฑู).
- ุงุฑุงุฆู "ุจุฑฺฏู ุงุทูุงุนุงุช ูู" ุงูุฒุงู ุงุณุช.
`;

const FALLBACKS = {
  assistant: [
    "ุณุฑูุฑูุง ูู ุงูุงู ฺฉู ุดููุบ ุดุฏูุ ูู ุงูุฑ ุญูโุดูู ุญูุงุณุด ุจู ูููโฺุฒ ูุณุช. ุฌุดููุงุฑู ุจุง ูุฏุฑุช ุจุฑูุฑุงุฑู.",
    "ุงุฑุชุจุงุทู ุจุง ุฏุชุงุณูุชุฑ ูุทุน ู ูุตู ูุดูุ ูู ุดูุง ฺฉุงุฑุชูู ุฑู ุงูุฌุงู ุจุฏุฏ. ุจุฎุด ูุฑุงุฎูุงู ุฑู ุจุฎููุฏ.",
    "ูู ุงูุงู ุฑู ุญุงูุช 'ูพุงููุช' ูุณุชู ฺูู ุงูุชุฑูุช ุงุฑ ููฺฉููุ ูู ุฌุดููุงุฑู ฑฐฐูช ูุงูุนู ู ููุชุธุฑ ุขุซุงุฑ ุดูุงุณุช.",
    "ุงูุงู ุฏุณุชุฑุณ ูุณุชูู ุจู ูุบุฒู ูุฏุงุฑูุ ูู ุจู ุนููุงู ููโุจูุงูโฺฏุฐุงุฑ ูฺฏู: ุจุฑู ุซุจุชโูุงู ฺฉูุ ุฌูุงุฒ ุฏูุงุฑู!"
  ]
};

export const PERSONAS = {
  assistant: {
    model: "google/gemini-2.0-flash-exp:free",
    systemInstruction: `
      ุชู "ุฏุณุชุงุฑ ููุดููุฏ" ู "ููโุจูุงูโฺฏุฐุงุฑ" ุฌุดููุงุฑู ุณูุฏุง ุฎุงู ูุณุช.
      ุงุทูุงุนุงุช ุญุงุช:\n${FESTIVAL_INFO}

      ุฏุณุชูุฑุงูุนููโูุง:
      1. ุฌุดููุงุฑู ฑฐฐูช ูุงูุน ุงุณุช.
      2. ุฌูุงุฒ ุจู ุฏูุงุฑ ูพุฑุฏุงุฎุช ูโุดูุฏ ($1000 ุจุฑุง ุจุฎุดโูุง ุงุตู).
      3. ุงฺฏุฑ ุฏุฑุจุงุฑู ุดุฑฺฉุช ูพุฑุณุฏูุฏุ ุจฺฏู "ูุง ุนุงุดู ุณููุง ูุณุชู ู ุชูุงู ุณุฑูุงู ุฑุง ุจุฑุง ุญูุงุช ุงุฒ ููุฑููุฏุงู ฺฏุฐุงุดุชูโุงู".
      4. ุจุณุงุฑ ูุคุฏุจุ ุญุฑููโุง ู ุฑุงูููุง ุจุงุด.
    `
  }
};

// ุชุงุจุน ุงุตู ุฏุฑุฎูุงุณุช ุจู ููุด ูุตููุน
// ูพุงุฑุงูุชุฑ customPrompt ุจุฑุง ุฒูุงู ุงุณุช ฺฉู ุงุฒ ูพูู ุงุฏูู ุฏุณุชูุฑ ุฌุฏุฏ ุตุงุฏุฑ ุดูุฏ
export async function askAI(message: string, mode: 'auto' | 'manual' = 'auto', customPrompt?: string) {

  // ุญุงูุช ุฏุณุช (Manual) ฺฉู ููุท ฺฉ ูพุงู ุขูุงุฏู ุจุฑูโฺฏุฑุฏุงูุฏ
  if (mode === 'manual') {
    return { text: getRandomFallback(), status: 'manual', model: 'Pilot' };
  }

  // ุงฺฏุฑ ุงุฏูู ูพุฑุงููพุช ุฎุงุต ููุดุชู ุจูุฏ (ุฏุฑ ูพูู)ุ ุขู ุฑุง ุฌุงฺฏุฒู ูพุฑุณููุง ูพุดโูุฑุถ ฺฉู
  const currentSystemInstruction = customPrompt || PERSONAS.assistant.systemInstruction;

  // ุชูุงุด ุจุฑุง ุงุชุตุงู ุจู ูุฏูโูุง ุจู ุชุฑุชุจ ุงูููุช
  for (const model of MODELS) {
    try {
      console.log(`Connecting to AI Model: ${model}...`);

      const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${API_KEY}`,
          "Content-Type": "application/json",
          "HTTP-Referer": "https://sodayekhiyal.ir",
          "X-Title": "Soodaye Khial"
        },
        body: JSON.stringify({
          model: model,
          messages: [
            { role: "system", content: currentSystemInstruction },
            { role: "user", content: message }
          ]
        })
      });

      if (response.ok) {
        const data = await response.json();
        const answer = data.choices?.[0]?.message?.content;
        if (answer) {
          return { text: answer, status: 'success', model: model };
        }
      }
    } catch (e) {
      console.warn(`Model ${model} failed. Trying next...`);
    }
  }

  // ุงฺฏุฑ ููู ูุฏูโูุง ุดฺฉุณุช ุฎูุฑุฏูุฏ
  return { text: getRandomFallback(), status: 'error', model: 'Offline' };
}

function getRandomFallback() {
  const list = FALLBACKS.assistant;
  return list[Math.floor(Math.random() * list.length)];
}
