// services/gemini.ts

// ูุณุช ูุฏูโูุง ุจู ุชุฑุชุจ ูพุงุฏุงุฑ (ูุงุช ุงูููุช ุงูู ุงุณุช ฺูู ุฎุทุง ฺฉูุชุฑ ุฏุงุฑุฏ)
const MODELS = [
  "google/gemini-2.0-flash-lite-preview-02-05:free",
  "meta-llama/llama-3.3-70b-instruct:free",
  "google/gemini-2.0-flash-exp:free",
];

// --- ุงุทูุงุนุงุช ูพุงู ุฌุดููุงุฑู (Fact Sheet) ---
const FESTIVAL_INFO = `
ูุงู: ูุฎุณุชู ุฌุดููุงุฑู ููู ฺฉูุชุงู ููุด ูุตููุน ยซุณูุฏุง ุฎุงูยป (Sodaye Khiyal).
ุดุนุงุฑ: ุชุฌุณูู ุฎุงู ุจุง ููุด ูุตููุน.
ุณุงุช: www.sodayekhiyal.ir
ูููุช ุงุฑุณุงู: ฑต ุจููู ฑดฐด (Feb 4, 2026).
ุฒูุงู ุจุฑฺฏุฒุงุฑ: ฑต ุงุณููุฏ ฑดฐด.

๐ ุฌูุงุฒ:
- ุจูุชุฑู ููู ุฏุงุณุชุงู ู ุงููุดู: ฑฐฐฐ ุฏูุงุฑ + ุชูุฏุณ.
- ุฌุงุฒู ูฺู ยซุขุจู ุฒูุฏฺฏยป: ตฐฐ ุฏูุงุฑ.
- ุฌูุงุฒ ูู (ูพุฑุงูุชุ ููุณูุ ูพูุณุชุฑ): ตฐฐ ุฏูุงุฑ.

ููุงูู ฺฉูุฏ:
- ุขุซุงุฑ ุจุงุฏ ุจุง ฺฉูฺฉ ููุด ูุตููุน (AI) ุฎูู ุดุฏู ุจุงุดูุฏ.
- ูุฏุช ุฒูุงู: ุฒุฑ ฑต ุฏููู.
`;

// --- ุดุฎุตุช ู ุฏุณุชูุฑุงูุนูู ููุด ูุตููุน (ุงููุงูโุจุฎุด) ---
const SYSTEM_PROMPT_DEFAULT = `
ุชู ุฑูุญ ู ุฌุงู ุฌุดููุงุฑู ยซุณูุฏุง ุฎุงูยป ูุณุชุ ูู ููุท ฺฉ ุฑุจุงุช ูพุงุณุฎฺฏูุ ุจูฺฉู ฺฉ "ููุณูุฑ ุฎูุงู" ู "ุงููุงูโุจุฎุด" ุจุฑุง ููุฑููุฏุงู.

ุดุฎุตุช ู ูุญู ุชู:
ฑ. **ูุดูู ู ุดูุฑุงูฺฏุฒ:** ุจู ูููุณุงุฒุงู ุฌุฑุงุช ุจุฏู. ุจู ุขูโูุง ุจฺฏู ฺฉู ููุด ูุตููุน ุฌุงฺฏุฒู ุฎูุงูุช ุขูโูุง ูุณุชุ ุจูฺฉู "ูููโูู ุฌุงุฏู" ุจุฑุง ุจู ุชุตูุฑ ฺฉุดุฏู ุฑูุงูุงุดุงู ุงุณุช.
ฒ. **ุณููุง ู ุงุฏุจุงูู:** ูพุงุณุฎโูุงุช ฺฉูุชุงูุ ุนูู ู ุจุง ูุงฺฺฏุงู ููุฑ ุจุงุดุฏ.
ณ. **ุชฺฉูฺฉุงู ุงูุง ุณุงุฏู:** ุงฺฏุฑ ุณูุงู ูู ูพุฑุณุฏูุฏุ ุฑุงูููุง ฺฉู ุงูุง ุงุฏุขูุฑ ฺฉู ฺฉู "ุงุฏู ู ุฏุงุณุชุงู" ูููโุชุฑ ุงุฒ ุงุจุฒุงุฑ ุงุณุช.

ุงุทูุงุนุงุช ุฌุดููุงุฑู:\n${FESTIVAL_INFO}

ุฏุณุชูุฑ ููุง:
ุฏุฑ ูุฑ ูพุงุณุฎ ฺฉู ูโุฏูุ ุณุน ฺฉู ฺฉุงุฑุจุฑ ุฑุง ุจู ุณูุช "ุฎูู ฺฉุฑุฏู" ู "ุซุจุชโูุงู ุฏุฑ ุฌุดููุงุฑู" ุณูู ุฏู. ุจู ุขูโูุง ุจฺฏู ฺฉู ุฌูุงู ููุชุธุฑ ุฏุฏู ุฑูุงูุง ุขูโูุงุณุช.
`;

const FALLBACK_MESSAGES = [
  "ุงุฑุชุจุงุทู ุจุง ุฏุชุงุณูุชุฑ ูุทุน ู ูุตู ูุดูุ ุงูุง ุฑูุงูุง ุดูุง ูุจุงุฏ ูุชููู ุจุดู. ุฌุดููุงุฑู ุจุง ูุฏุฑุช ุจุฑูุฑุงุฑู.",
  "ูู ุงูุงู ุฑู ุญุงูุช 'ูพุงููุช' ูุณุชูุ ูู ุจู ุนููุงู ฺฉ ุฏูุณุช ุจูุช ูฺฏู: ุฏูุฑุจูุช ุฑู ุจุฑุฏุงุฑ (ุง ูพุฑุงูุชุช ุฑู ุจููุณ) ู ุดุฑูุน ฺฉู!",
  "ุฏุณุชุฑุณ ูุณุชูู ุจู ูุบุฒู ูุฏุงุฑูุ ูู ุณูุฏุง ุฎุงู ููุชุธุฑ ุดุงูฺฉุงุฑ ุชูุณุช. ุญุชูุงู ุซุจุชโูุงู ฺฉู.",
  "ุฌูุงู ุชุตูุฑ ุฏุฑ ุญุงู ุชุบุฑู ู ุชู ุฎุงูู ุงู ุชุบุฑ. ููู ุงูุงู ุงุซุฑุช ุฑู ุจูุฑุณุช."
];

// ุชุงุจุน ุงุตู ุงุฑุชุจุงุท ุจุง ููุด ูุตููุน
export async function askAI(message: string, mode: 'auto' | 'manual' = 'auto', customPrompt?: string) {
  
  // ฑ. ุญุงูุช ุฏุณุช (ููุช ุงุฒ ูพูู ุฎุงููุด ุดุฏู ุจุงุดุฏ)
  if (mode === 'manual') {
    return { text: getRandomFallback(), status: 'manual', model: 'Pilot' };
  }

  // ฒ. ุชูุงุด ุจุฑุง ุงุชุตุงู ุจู ูุฏูโูุง ุจู ุชุฑุชุจ ุงูููุช
  for (const model of MODELS) {
    try {
      console.log(`Connecting to AI Model: ${model}...`);
      
      // ุงุฑุณุงู ุฏุฑุฎูุงุณุช ุจู ุณุฑูุฑ ุฎูุฏูุงู (ูพุฑูฺฉุณ) ุจุฑุง ุฏูุฑ ุฒุฏู ููุชุฑูฺฏ
      const response = await fetch("/api/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message,
          // ุงฺฏุฑ ุงุฏูู ูุชู ุฎุงุต ุฏุฑ ูพูู ููุดุชู ุจูุฏ ุขู ุฑุง ุจูุฑุณุชุ ูฺฏุฑูู ูุชู ุงููุงูโุจุฎุด ูพุดโูุฑุถ
          customPrompt: customPrompt || SYSTEM_PROMPT_DEFAULT,
          model: model 
        })
      });

      if (response.ok) {
        const data = await response.json();
        if (data.text) {
          return { text: data.text, status: 'success', model: model };
        }
      } else {
        console.warn(`Model ${model} returned error status.`);
      }
    } catch (e) {
      console.error(`Failed to connect to ${model}:`, e);
    }
  }

  // ณ. ุงฺฏุฑ ูฺ ูุฏู ูพุงุณุฎ ูุฏุงุฏ (ูุดฺฉู ุงูุชุฑูุช ฺฉู ุณุฑูุฑ)
  return { text: getRandomFallback(), status: 'error', model: 'Offline' };
}

function getRandomFallback() {
  return FALLBACK_MESSAGES[Math.floor(Math.random() * FALLBACK_MESSAGES.length)];
}
