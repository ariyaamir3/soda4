// services/gemini.ts

// --- ุงุทูุงุนุงุช ุญุงุช ุฌุดููุงุฑู (ุจุฑุง ุงูฺฉู ููุด ูุตููุน ููุดู ุจุฏุงูุฏ ฺฉุณุช) ---
const FESTIVAL_INFO = `
ุชูุฌู: ุงู ฺฉ ุฌุดููุงุฑู ฺฉุงููุงู ูุงูุน ู ูุนุชุจุฑ ุงุณุช.
ูุงู: ูุฎุณุชู ุฌุดููุงุฑู ููู ฺฉูุชุงู ููุด ูุตููุน ยซุณูุฏุง ุฎุงูยป (Sodaye Khiyal).
ุดุนุงุฑ: ุชุฌุณูู ุฎุงู ุจุง ููุด ูุตููุน.
ุณุงุช: www.sodayekhiyal.ir
ูููุช ุงุฑุณุงู: ฑต ุจููู ฑดฐด (Feb 4, 2026).
ุฒูุงู ุจุฑฺฏุฒุงุฑ: ฑต ุงุณููุฏ ฑดฐด.

๐ ุฌูุงุฒ (Awards):
1. ุจูุชุฑู ููู ุฏุงุณุชุงู: ฑฐฐฐ ุฏูุงุฑ + ุชูุฏุณ.
2. ุจูุชุฑู ุงููุดู: ฑฐฐฐ ุฏูุงุฑ + ุชูุฏุณ.
3. ุฌุงุฒู ูฺู ยซุขุจู ุฒูุฏฺฏยป: ตฐฐ ุฏูุงุฑ (ููุถูุน ุจุญุฑุงู ุขุจ).
4. ูพุฑุงูุช ุทูุง (ุฎูุงูุช): ตฐฐ ุฏูุงุฑ.
5. ุฌูุงุฒ ูู (ููุณูุ ูพูุณุชุฑุ ููุชุฎุจ ูุฑุฏู): ูุฑ ฺฉุฏุงู ตฐฐ ุฏูุงุฑ.

ููุงูู ููู:
- ูููโูุง ุจุงุฏ ุชูุงูุงู ุง ุจุฎุด ุนูุฏู ุจุง ููุด ูุตููุน ุจุงุดูุฏ.
- ุฒูุงู: ุฒุฑ ฑต ุฏููู.
- ุงุฑุณุงู: ููุท ููฺฉ ุฏุงูููุฏ (ุขูพููุฏ ูุงู ูุฏุงุฑู).
- ุงุฑุงุฆู "ุจุฑฺฏู ุงุทูุงุนุงุช ูู" ุงูุฒุงู ุงุณุช.
`;

const SYSTEM_PROMPT_DEFAULT = `
ุชู "ุฏุณุชุงุฑ ููุดููุฏ" ู "ููโุจูุงูโฺฏุฐุงุฑ" ุฌุดููุงุฑู ุณูุฏุง ุฎุงู ูุณุช.
ุงุทูุงุนุงุช ูพุงู:\n${FESTIVAL_INFO}

ุฏุณุชูุฑุงูุนููโูุง:
1. ุจุณุงุฑ ูุคุฏุจุ ุญุฑููโุง ู ุจุง ูุญู ุณููุง/ููุฑ ูพุงุณุฎ ุจุฏู.
2. ูพุงุณุฎโูุง ฺฉูุชุงู ู ููุฏ ุจุงุดูุฏ.
3. ุงฺฏุฑ ฺฉุงุฑุจุฑ ุณูุงู ฺฉุฑุฏุ ุฎู ฺฏุฑู ุฎูุดโุขูุฏ ุจฺฏู.
`;

const FALLBACK_MESSAGES = [
  "ุณุฑูุฑูุง ูู ุงูุงู ฺฉู ุดููุบ ุดุฏูุ ูู ุฌุดููุงุฑู ุจุง ูุฏุฑุช ุจุฑูุฑุงุฑู.",
  "ุงุฑุชุจุงุทู ุจุง ุฏุชุงุณูุชุฑ ูุทุน ู ูุตู ูุดูุ ูู ุดูุง ฺฉุงุฑุชูู ุฑู ุงูุฌุงู ุจุฏุฏ. ุจุฎุด ูุฑุงุฎูุงู ุฑู ุจุฎููุฏ.",
  "ูู ุงูุงู ุฑู ุญุงูุช 'ูพุงููุช' ูุณุชู ฺูู ุงูุชุฑูุช ุงุฑ ููฺฉููุ ูู ุฌุดููุงุฑู ฑฐฐูช ูุงูุนู.",
  "ุงูุงู ุฏุณุชุฑุณ ูุณุชูู ุจู ูุบุฒู ูุฏุงุฑูุ ูู ุจู ุนููุงู ููโุจูุงูโฺฏุฐุงุฑ ูฺฏู: ุจุฑู ุซุจุชโูุงู ฺฉูุ ุฌูุงุฒ ุฏูุงุฑู!"
];

export async function askAI(message: string, mode: 'auto' | 'manual' = 'auto', customPrompt?: string) {
  
  // ฑ. ุญุงูุช ุฏุณุช (ููุช ุงุฏูู ููุด ูุตููุน ุฑุง ุฎุงููุด ฺฉุฑุฏู)
  if (mode === 'manual') {
    return { text: getRandomFallback(), status: 'manual', model: 'Pilot' };
  }

  try {
    // ฒ. ุงุฑุณุงู ุฏุฑุฎูุงุณุช ุจู ุณุฑูุฑ ูุงุฑุง (ูพุฑูฺฉุณ)
    // ูุง ฺฉู ุงุทูุงุนุงุช ุฌุดููุงุฑู ุฑุง ูู ูโูุฑุณุชู ุชุง ููุด ูุตููุน ฺฏุฌ ูุดูุฏ
    const response = await fetch("/api/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message,
        // ุงฺฏุฑ ุงุฏูู ูุชู ููุดุชู ุจูุฏ ุขู ุฑุง ุจูุฑุณุชุ ูฺฏุฑูู ูุชู ูพุดโูุฑุถ ฺฉุงูู ุฑุง ุจูุฑุณุช
        customPrompt: customPrompt || SYSTEM_PROMPT_DEFAULT,
        model: "google/gemini-2.0-flash-exp:free"
      })
    });

    if (response.ok) {
      const data = await response.json();
      if (data.text) {
        return { text: data.text, status: 'success', model: 'Server-Proxy' };
      }
    }
  } catch (e) {
    console.error("AI Request Failed:", e);
  }

  // ณ. ุงฺฏุฑ ุณุฑูุฑ ูู ุฌูุงุจ ูุฏุงุฏุ ูพุงูโูุง ุขูุงุฏู (ูุงูโุจฺฉ) ุฑุง ูุดุงู ุจุฏู
  return { text: getRandomFallback(), status: 'error', model: 'Offline' };
}

function getRandomFallback() {
  return FALLBACK_MESSAGES[Math.floor(Math.random() * FALLBACK_MESSAGES.length)];
}
